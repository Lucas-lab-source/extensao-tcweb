<!DOCTYPE html>
<html>
<head>
  <title>Controle de Versão de Plantas</title>
  <script src="https://unpkg.com/trimble-connect-project-workspace-api"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    /* Estilo simples do modal */
    #modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
    }
    #modalContent {
      background: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      width: 300px;
    }
    button { margin: 10px; padding: 10px; }
  </style>
</head>
<body>
  <canvas id="qrCode" style="display:none;"></canvas>

  <div id="modal">
    <div id="modalContent">
      <h2>Controle de Versão de Plantas</h2>
      <button id="btnGerarPDF">Gerar PDF com QR Code</button><br>
      <input type="text" id="qrInput" placeholder="Digite ou escaneie QR Code">
      <button id="btnVerificar">Verificar Planta</button>
    </div>
  </div>

  <script type="module">
    import * as Extensions from "trimble-connect-project-workspace-api";
    import { jsPDF } from "https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js";

    async function iniciarExtensao() {
      const API = await Extensions.connect(
        window.parent,
        (event, args) => {
          if(event === "extension.command" && args.data === "abrir_config"){
            alert("Abrindo configurações da extensão!");
          }
        },
        30000
      );

      const projectInfo = await API.project.getCurrentProject();
      const versaoAtual = projectInfo.version || "1.0";

      const qr = new QRious({
        element: document.getElementById('qrCode'),
        value: projectInfo.id + "|" + versaoAtual,
        size: 150
      });

      // Mostrar o modal automaticamente ao abrir
      const modal = document.getElementById('modal');
      modal.style.display = "flex";

      // Gerar PDF
      document.getElementById("btnGerarPDF").addEventListener("click", () => {
        const pdf = new jsPDF();
        pdf.setFontSize(16);
        pdf.text(`Projeto: ${projectInfo.name}`, 20, 20);
        pdf.text(`Versão: ${versaoAtual}`, 20, 30);

        const qrDataURL = qr.toDataURL();
        pdf.addImage(qrDataURL, 'PNG', 160, 10, 40, 40);

        pdf.save(`${projectInfo.name}-versao.pdf`);
      });

      // Verificar QR Code
      document.getElementById("btnVerificar").addEventListener("click", () => {
        const qrInput = document.getElementById("qrInput").value.trim();
        if (!qrInput) { alert("Digite ou escaneie o QR Code!"); return; }

        if (qrInput === projectInfo.id + "|" + versaoAtual) {
          alert("✅ Planta está atualizada!");
        } else {
          alert("❌ Planta NÃO está atualizada!");
        }
      });
    }

    iniciarExtensao();
  </script>
</body>
</html>

